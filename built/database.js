//     database
//     (c) simonfan
//     database is licensed under the MIT terms.

define("__database/query-object/exec",["require","exports","module","lodash","q"],function(t,e){var i=t("lodash"),a=t("q");e.sync=function(t){var e=a.defer(),r=this.meta(),s=this.clientExec("id").toArray(),n={meta:r,loaded:s,criteria:this.criteria};return this.database.load(n,t).then(i.partial(e.resolve,this)),e.promise},e.exec=function(t,e){var r=a.defer(),s=this.sync(e);return s.done(i.bind(function(){var e=this.clientExec(t).toArray();r.resolve(e)},this)),r.promise},e.clientExec=function(t){var e=this.meta("sort-attributes"),i=this.meta("sort-directions"),a=this.meta("skip"),r=this.meta("limit");this.database.multisort(e,i);var s=this.database.find(this.criteria,t);return s=a?s.rest(a):s,s=r?s.take(r):s}}),define("__database/query-object/meta",["require","exports","module","lodash"],function(t,e){var i=t("lodash");e.meta=function(t,e){return 1===arguments.length?this.metaData[t]:2===arguments.length?(this.metaData[t]=e,this):0===arguments.length?i.clone(this.metaData):void 0},e.skip=i.partial(e.meta,"skip"),e.limit=i.partial(e.meta,"limit"),e.sortBy=function(t,e){if(i.isString(t)){var a=this.meta("sorting-attributes")||[],r=this.meta("sorting-directions")||{};a.push(t),r[t]=e,this.meta("sorting-attributes",a).meta("sorting-directions",r)}else i.isArray(t)&&this.meta("sorting-attributes",t).meta("sorting-directions",e);return this}}),define("__database/query-object/index",["require","exports","module","subject","lodash","./exec","./meta"],function(t,e,i){var a=t("subject"),r=t("lodash"),s=i.exports=a({initialize:function(t,e,i){this.database=t,this.criteria=r.clone(e),this.metaData=r.clone(i),this._syncedIntervals=[]}});s.assignProto(t("./exec")),s.assignProto(t("./meta"))}),define("__database/filtered-collection",["require","exports","module","lowercase-backbone"],function(t,e,i){{var a=t("lowercase-backbone"),r=["database","filterModel","pageLength","formatCriteria","filterAttributes"],s=a.collection.prototype.initialize;i.exports=a.collection.extend({initialize:function(t,e){if(s.call(this,t,e),e=e||{},_.each(r,function(t){this[t]=void 0!=e[t]?e[t]:this[t]},this),!this.database)throw new Error("No database found on filtered collection.");this.filterModel||(this.filterModel=a.model()),this.listenTo(this.filterModel,"change",this.handleFilterModelChange)},filterAttributes:!1,formatCriteria:function(t){var e={};return _.each(t,function(t,i){t&&this.filterAttributes&&_.contains(this.filterAttributes,i)&&(e[i]=t)},this),e},pageLength:10,handleFilterModelChange:function(){this.reset([]);var t=this.filterModel.toJSON();t=this.formatCriteria(t),this.query(t).done(_.bind(function(t){this.reset(_.pluck(t,"attributes"))},this))},query:function n(t){var n=this.database.query(t);return n.skip(this.length).limit(this.pageLength),n.exec()}})}}),define("__database/xhr",["require","exports","module","lodash"],function(t,e){var i=t("lodash");e.xhrOptions={},e.load=function(t,e){t=this.mapRequestData(t);var a=this.cache(t);if(a)return a;var r=i.extend({data:t,remove:!1},this.xhrOptions,e),s=this.fetch(r);return this.cache(t,s)},e.dataMap={},e.mapRequestData=function(t){return i.each(this.dataMap,function(e,i){var a=t[i];t[e]=a,delete t[i]}),t},e.cache=function(t,e){var i=JSON.stringify(t);return arguments.length<2?this._cache[i]:this._cache[i]=e},e.syncStatus=function(){}}),define("database",["require","exports","module","backbone.collection.queryable","backbone.collection.multisort","backbone.collection.lazy","lowercase-backbone","lodash","q","./__database/query-object/index","./__database/filtered-collection","./__database/xhr"],function(t,e,i){var a=t("backbone.collection.queryable"),r=t("backbone.collection.multisort"),s=t("backbone.collection.lazy"),n=t("lowercase-backbone"),o=t("lodash"),l=t("q"),c=t("./__database/query-object/index"),h=t("./__database/filtered-collection"),u=i.exports=n.collection.extend(s.prototype).extend(r.prototype).extend(a.prototype);u.assignProto({initialize:function(t,e){n.collection.prototype.initialize.apply(this,arguments),s.prototype.initialize.apply(this,arguments),r.prototype.initialize.apply(this,arguments),a.prototype.initialize.apply(this,arguments),e=e||{},o.assign(this,e),this.metaData=e.metaData||o.clone(this.metaData),this._cache={},this._queries={}},defaultQueryMeta:{limit:10,skip:0},query:function(t){t=t||{};var e=JSON.stringify(t),i=this._queries[e]||c(this,t,o.clone(this.defaultQueryMeta));return this._queries[e]=i,i},queryOne:function(t){var e=l.defer();t=t||{};var i=this.findOne(t);return i?e.resolve(i):this.query(t).limit(1).exec().done(function(t){e.resolve(t[0])}),e.promise},filtered:function(t){return t=t||{},t.database=this,(_filteredCollection=h.extend({model:this.model}))([],t)}}),u.assignProto(t("./__database/xhr"))});