//     database
//     (c) simonfan
//     database is licensed under the MIT terms.

define("__database/query-object/exec",["require","exports","module","lodash","q"],function(t,e){var a=t("lodash"),i=t("q");e.sync=function(t){var e=i.defer(),r=this.meta(),s=this.clientExec("id").toArray(),o={meta:r,loaded:s,criteria:this.criteria};return this.database.load(o,t).then(a.partial(e.resolve,this)),e.promise},e.exec=function(t,e){var r=i.defer(),s=this.sync(e);return s.then(a.bind(function(){var e=this.clientExec(t).toArray();r.resolve(e)},this)),r.promise},e.clientExec=function(t){var e=this.meta("sort-attributes"),a=this.meta("sort-directions"),i=this.meta("skip"),r=this.meta("limit");this.database.multisort(e,a);var s=this.database.find(this.criteria,t);return s=i?s.rest(i):s,s=r?s.take(r):s}}),define("__database/query-object/meta",["require","exports","module","lodash"],function(t,e){var a=t("lodash");e.meta=function(t,e){return 1===arguments.length?this.metaData[t]:2===arguments.length?(this.metaData[t]=e,this):0===arguments.length?a.clone(this.metaData):void 0},e.skip=a.partial(e.meta,"skip"),e.limit=a.partial(e.meta,"limit"),e.sortBy=function(t,e){if(a.isString(t)){var i=this.meta("sorting-attributes")||[],r=this.meta("sorting-directions")||{};i.push(t),r[t]=e,this.meta("sorting-attributes",i).meta("sorting-directions",r)}else a.isArray(t)&&this.meta("sorting-attributes",t).meta("sorting-directions",e);return this}}),define("__database/query-object/index",["require","exports","module","subject","lodash","./exec","./meta"],function(t,e,a){var i=t("subject"),r=t("lodash"),s=a.exports=i(function(t,e,a){this.database=t,this.criteria=r.clone(e),this.metaData=r.clone(a),this._syncedIntervals=[]});s.proto(t("./exec")),s.proto(t("./meta"))}),define("__database/xhr",["require","exports","module","lodash"],function(t,e){var a=t("lodash");e.xhrOptions={},e.load=function(t,e){t=this.mapRequestData(t);var i=this.cache(t);if(i)return i;var r=a.extend({data:t,remove:!1},this.xhrOptions,e),s=this.fetch(r);return this.cache(t,s)},e.dataMap={},e.mapRequestData=function(t){return a.each(this.dataMap,function(e,a){var i=t[a];t[e]=i,delete t[a]}),t},e.cache=function(t,e){var a=JSON.stringify(t);return arguments.length<2?this._cache[a]:this._cache[a]=e},e.syncStatus=function(){}}),define("database",["require","exports","module","backbone.collection.queryable","backbone.collection.multisort","backbone.collection.lazy","lowercase-backbone","lodash","./__database/query-object/index","./__database/xhr"],function(t,e,a){var i=t("backbone.collection.queryable"),r=t("backbone.collection.multisort"),s=t("backbone.collection.lazy"),o=t("lowercase-backbone"),n=t("lodash"),c=t("./__database/query-object/index"),h=a.exports=o.collection.extend(s.prototype).extend(r.prototype).extend(i.prototype);h.proto({initialize:function(t,e){o.collection.prototype.initialize.apply(this,arguments),s.prototype.initialize.apply(this,arguments),r.prototype.initialize.apply(this,arguments),i.prototype.initialize.apply(this,arguments),n.assign(this,e),this.metaData=e.metaData||n.clone(this.metaData),this._cache={},this._queries={}},defaultQueryMeta:{limit:10,skip:0},query:function l(t){t=t||{};var e=JSON.stringify(t),l=this._queries[e]||c(this,t,n.clone(this.defaultQueryMeta));return this._queries[e]=l,l}}),h.proto(t("./__database/xhr"))});