//     database
//     (c) simonfan
//     database is licensed under the MIT terms.

define("__database/query-object/exec",["require","exports","module","lodash","q"],function(t,e){var a=t("lodash"),i=t("q");e.sync=function(t){var e=i.defer(),s=this.meta(),r=this.clientExec("id").toArray(),n={meta:s,loaded:r,criteria:this.criteria};return this.database.load(n,t).then(a.partial(e.resolve,this)),e.promise},e.exec=function(t,e){var s=i.defer(),r=this.sync(e);return r.done(a.bind(function(){var e=this.clientExec(t).toArray();s.resolve(e)},this)),s.promise},e.clientExec=function(t){var e=this.meta("sort-attributes"),a=this.meta("sort-directions"),i=this.meta("skip"),s=this.meta("limit");this.database.multisort(e,a);var r=this.database.find(this.criteria,t);return r=i?r.rest(i):r,r=s?r.take(s):r}}),define("__database/query-object/meta",["require","exports","module","lodash"],function(t,e){var a=t("lodash");e.meta=function(t,e){return 1===arguments.length?this.metaData[t]:2===arguments.length?(this.metaData[t]=e,this):0===arguments.length?a.clone(this.metaData):void 0},e.skip=a.partial(e.meta,"skip"),e.limit=a.partial(e.meta,"limit"),e.sortBy=function(t,e){if(a.isString(t)){var i=this.meta("sorting-attributes")||[],s=this.meta("sorting-directions")||{};i.push(t),s[t]=e,this.meta("sorting-attributes",i).meta("sorting-directions",s)}else a.isArray(t)&&this.meta("sorting-attributes",t).meta("sorting-directions",e);return this}}),define("__database/query-object/index",["require","exports","module","subject","lodash","./exec","./meta"],function(t,e,a){var i=t("subject"),s=t("lodash"),r=a.exports=i({initialize:function(t,e,a){this.database=t,this.criteria=s.clone(e),this.metaData=s.clone(a),this._syncedIntervals=[]}});r.assignProto(t("./exec")),r.assignProto(t("./meta"))}),define("__database/xhr",["require","exports","module","lodash"],function(t,e){var a=t("lodash");e.xhrOptions={},e.load=function(t,e){t=this.mapRequestData(t);var i=this.cache(t);if(i)return i;var s=a.extend({data:t,remove:!1},this.xhrOptions,e),r=this.fetch(s);return this.cache(t,r)},e.dataMap={},e.mapRequestData=function(t){return a.each(this.dataMap,function(e,a){var i=t[a];t[e]=i,delete t[a]}),t},e.cache=function(t,e){var a=JSON.stringify(t);return arguments.length<2?this._cache[a]:this._cache[a]=e},e.syncStatus=function(){}}),define("database",["require","exports","module","backbone.collection.queryable","backbone.collection.multisort","backbone.collection.lazy","lowercase-backbone","lodash","./__database/query-object/index","./__database/xhr"],function(t,e,a){var i=t("backbone.collection.queryable"),s=t("backbone.collection.multisort"),r=t("backbone.collection.lazy"),n=t("lowercase-backbone"),o=t("lodash"),c=t("./__database/query-object/index"),l=a.exports=n.collection.extend(r.prototype).extend(s.prototype).extend(i.prototype);l.assignProto({initialize:function(t,e){n.collection.prototype.initialize.apply(this,arguments),r.prototype.initialize.apply(this,arguments),s.prototype.initialize.apply(this,arguments),i.prototype.initialize.apply(this,arguments),o.assign(this,e),this.metaData=e.metaData||o.clone(this.metaData),this._cache={},this._queries={}},defaultQueryMeta:{limit:10,skip:0},query:function(t){t=t||{};var e=JSON.stringify(t),a=this._queries[e]||c(this,t,o.clone(this.defaultQueryMeta));return this._queries[e]=a,a}}),l.assignProto(t("./__database/xhr"))});