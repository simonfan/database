//     database
//     (c) simonfan
//     database is licensed under the MIT terms.

define("__database/query-object/exec",["require","exports","module","lodash","q"],function(e,t){var i=e("lodash"),a=e("q");t.sync=function(e){var t=a.defer(),s=this.meta(),r=this.clientExec("id").toArray(),n={meta:s,loaded:r,criteria:this.criteria};return this.database.load(n,e).then(i.partial(t.resolve,this)),t.promise},t.exec=function(e,t){var s=a.defer(),r=this.sync(t);return r.done(i.bind(function(){var t=this.clientExec(e).toArray();s.resolve(t)},this)),s.promise},t.clientExec=function(e){var t=this.meta("sort-attributes"),i=this.meta("sort-directions"),a=this.meta("skip"),s=this.meta("limit");this.database.multisort(t,i);var r=this.database.find(this.criteria,e);return r=a?r.rest(a):r,r=s?r.take(s):r}}),define("__database/query-object/meta",["require","exports","module","lodash"],function(e,t){var i=e("lodash");t.meta=function(e,t){return 1===arguments.length?this.metaData[e]:2===arguments.length?(this.metaData[e]=t,this):0===arguments.length?i.clone(this.metaData):void 0},t.skip=i.partial(t.meta,"skip"),t.limit=i.partial(t.meta,"limit"),t.sortBy=function(e,t){if(i.isString(e)){var a=this.meta("sorting-attributes")||[],s=this.meta("sorting-directions")||{};a.push(e),s[e]=t,this.meta("sorting-attributes",a).meta("sorting-directions",s)}else i.isArray(e)&&this.meta("sorting-attributes",e).meta("sorting-directions",t);return this}}),define("__database/query-object/index",["require","exports","module","subject","lodash","./exec","./meta"],function(e,t,i){var a=e("subject"),s=e("lodash"),r=i.exports=a({initialize:function(e,t,i){this.database=e,this.criteria=s.clone(t),this.metaData=s.clone(i),this._syncedIntervals=[]}});r.assignProto(e("./exec")),r.assignProto(e("./meta"))}),define("__database/filtered-collection",["require","exports","module","lowercase-backbone"],function(e,t,i){{var a=e("lowercase-backbone"),s=["database","filter","pageLength"],r=a.collection.prototype.initialize;i.exports=a.collection.extend({initialize:function(e,t){if(r.call(this,e,t),t=t||{},_.each(s,function(e){this[e]=void 0!=t[e]?t[e]:this[e]},this),!this.database)throw new Error("No database found on filtered collection.");this.filterModel||(this.filterModel=a.model()),this.listenTo(this.filterModel,"change",this.handleFilterModelChange)},pageLength:10,handleFilterModelChange:function(){this.reset([]);var e=this.filterModel.toJSON();this.query(e).done(_.bind(function(e){this.reset(e)},this))},query:function n(e){var n=this.database.query(e);return n.skip(this.length).limit(this.pageLength),n.exec()}})}}),define("__database/xhr",["require","exports","module","lodash"],function(e,t){var i=e("lodash");t.xhrOptions={},t.load=function(e,t){e=this.mapRequestData(e);var a=this.cache(e);if(a)return a;var s=i.extend({data:e,remove:!1},this.xhrOptions,t),r=this.fetch(s);return this.cache(e,r)},t.dataMap={},t.mapRequestData=function(e){return i.each(this.dataMap,function(t,i){var a=e[i];e[t]=a,delete e[i]}),e},t.cache=function(e,t){var i=JSON.stringify(e);return arguments.length<2?this._cache[i]:this._cache[i]=t},t.syncStatus=function(){}}),define("database",["require","exports","module","backbone.collection.queryable","backbone.collection.multisort","backbone.collection.lazy","lowercase-backbone","lodash","q","./__database/query-object/index","./__database/filtered-collection","./__database/xhr"],function(e,t,i){var a=e("backbone.collection.queryable"),s=e("backbone.collection.multisort"),r=e("backbone.collection.lazy"),n=e("lowercase-backbone"),o=e("lodash"),l=e("q"),c=e("./__database/query-object/index"),h=e("./__database/filtered-collection"),d=i.exports=n.collection.extend(r.prototype).extend(s.prototype).extend(a.prototype);d.assignProto({initialize:function(e,t){n.collection.prototype.initialize.apply(this,arguments),r.prototype.initialize.apply(this,arguments),s.prototype.initialize.apply(this,arguments),a.prototype.initialize.apply(this,arguments),t=t||{},o.assign(this,t),this.metaData=t.metaData||o.clone(this.metaData),this._cache={},this._queries={}},defaultQueryMeta:{limit:10,skip:0},query:function(e){e=e||{};var t=JSON.stringify(e),i=this._queries[t]||c(this,e,o.clone(this.defaultQueryMeta));return this._queries[t]=i,i},queryOne:function(e){var t=l.defer();e=e||{};var i=this.findOne(e);return i?t.resolve(i):this.query(e).limit(1).exec().done(function(e){t.resolve(e[0])}),t.promise},filtered:function(e){return e=e||{},e.database=this,(_filteredCollection=h.extend({model:this.model}))([],e)}}),d.assignProto(e("./__database/xhr"))});