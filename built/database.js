//     database
//     (c) simonfan
//     database is licensed under the MIT terms.

define("__database/query-object/exec",["require","exports","module","lodash","q"],function(t,e){var i=t("lodash"),a=t("q");e.sync=function(t){var e=a.defer(),s=this.meta(),r=this.clientExec("id").toArray(),n={meta:s,loaded:r,criteria:this.criteria};return this.database.load(n,t).then(i.partial(e.resolve,this)),e.promise},e.exec=function(t,e){var s=a.defer(),r=this.sync(e);return r.done(i.bind(function(){var e=this.clientExec(t).toArray();s.resolve(e)},this)),s.promise},e.clientExec=function(t){var e=this.meta("sort-attributes"),i=this.meta("sort-directions"),a=this.meta("skip"),s=this.meta("limit");this.database.multisort(e,i);var r=this.database.find(this.criteria,t);return r=a?r.rest(a):r,r=s?r.take(s):r}}),define("__database/query-object/meta",["require","exports","module","lodash"],function(t,e){var i=t("lodash");e.meta=function(t,e){return 1===arguments.length?this.metaData[t]:2===arguments.length?(this.metaData[t]=e,this):0===arguments.length?i.clone(this.metaData):void 0},e.skip=i.partial(e.meta,"skip"),e.limit=i.partial(e.meta,"limit"),e.sortBy=function(t,e){if(i.isString(t)){var a=this.meta("sorting-attributes")||[],s=this.meta("sorting-directions")||{};a.push(t),s[t]=e,this.meta("sorting-attributes",a).meta("sorting-directions",s)}else i.isArray(t)&&this.meta("sorting-attributes",t).meta("sorting-directions",e);return this}}),define("__database/query-object/index",["require","exports","module","subject","lodash","./exec","./meta"],function(t,e,i){var a=t("subject"),s=t("lodash"),r=i.exports=a({initialize:function(t,e,i){this.database=t,this.criteria=s.clone(e),this.metaData=s.clone(i),this._syncedIntervals=[]}});r.assignProto(t("./exec")),r.assignProto(t("./meta"))}),define("__database/filtered-collection",["require","exports","module","lowercase-backbone"],function(t,e,i){{var a=t("lowercase-backbone"),s=["database","filterModel","pageLength"],r=a.collection.prototype.initialize;i.exports=a.collection.extend({initialize:function(t,e){if(r.call(this,t,e),e=e||{},_.each(s,function(t){this[t]=void 0!=e[t]?e[t]:this[t]},this),!this.database)throw new Error("No database found on filtered collection.");this.filterModel||(this.filterModel=a.model()),this.listenTo(this.filterModel,"change",this.handleFilterModelChange)},pageLength:10,handleFilterModelChange:function(){this.reset([]);var t=this.filterModel.toJSON();this.query(t).done(_.bind(function(t){this.reset(_.pluck(t,"attributes"))},this))},query:function n(t){var n=this.database.query(t);return n.skip(this.length).limit(this.pageLength),n.exec()}})}}),define("__database/xhr",["require","exports","module","lodash"],function(t,e){var i=t("lodash");e.xhrOptions={},e.load=function(t,e){t=this.mapRequestData(t);var a=this.cache(t);if(a)return a;var s=i.extend({data:t,remove:!1},this.xhrOptions,e),r=this.fetch(s);return this.cache(t,r)},e.dataMap={},e.mapRequestData=function(t){return i.each(this.dataMap,function(e,i){var a=t[i];t[e]=a,delete t[i]}),t},e.cache=function(t,e){var i=JSON.stringify(t);return arguments.length<2?this._cache[i]:this._cache[i]=e},e.syncStatus=function(){}}),define("database",["require","exports","module","backbone.collection.queryable","backbone.collection.multisort","backbone.collection.lazy","lowercase-backbone","lodash","q","./__database/query-object/index","./__database/filtered-collection","./__database/xhr"],function(t,e,i){var a=t("backbone.collection.queryable"),s=t("backbone.collection.multisort"),r=t("backbone.collection.lazy"),n=t("lowercase-backbone"),o=t("lodash"),l=t("q"),c=t("./__database/query-object/index"),h=t("./__database/filtered-collection"),d=i.exports=n.collection.extend(r.prototype).extend(s.prototype).extend(a.prototype);d.assignProto({initialize:function(t,e){n.collection.prototype.initialize.apply(this,arguments),r.prototype.initialize.apply(this,arguments),s.prototype.initialize.apply(this,arguments),a.prototype.initialize.apply(this,arguments),e=e||{},o.assign(this,e),this.metaData=e.metaData||o.clone(this.metaData),this._cache={},this._queries={}},defaultQueryMeta:{limit:10,skip:0},query:function(t){t=t||{};var e=JSON.stringify(t),i=this._queries[e]||c(this,t,o.clone(this.defaultQueryMeta));return this._queries[e]=i,i},queryOne:function(t){var e=l.defer();t=t||{};var i=this.findOne(t);return i?e.resolve(i):this.query(t).limit(1).exec().done(function(t){e.resolve(t[0])}),e.promise},filtered:function(t){return t=t||{},t.database=this,(_filteredCollection=h.extend({model:this.model}))([],t)}}),d.assignProto(t("./__database/xhr"))});